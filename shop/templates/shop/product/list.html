{% extends "shop/base.html" %}
{% load static %}
{% load static custom_filters %}


{% block flasher %}
{% if active_sales %}
    <div class="flash-banner-container">
        {% for sale in active_sales %}
            <div class="flash-banner" style="background-image: url('{% if sale.image %}{{ sale.image.url }}{% else %}https://via.placeholder.com/1920x300/{{ sale.background_color }}{% endif %}');">
                <div class="flash-banner-text">
                    <h2>{{ sale.message }}</h2>
                    <p>{{ sale.get_discount_text }}</p>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}
{% endblock %}

{% block banner %}
{% static 'shop/banner.png' as img_url %}  {# Use a skincare-themed banner image #}
<div class="scroll-animate images" style="background-image: url('{{ img_url }}'); height: 400px; background-size: cover; display: flex; flex-direction: column; align-items: center; justify-content: center;">
    <h1 class="scroll-animate" style="color: #fff; font-size: 3rem; font-weight: bold;">Welcome to Radiant Skin</h1>
    <div class="images scroll-animate" style="width: 30%;">
        <img style="height: 100%;" src="{% static 'shop/skincare-logo.png' %}" alt="Radiant Skin Logo">
    </div>
</div>
{% endblock %}

{% block title %}
    {% if category %}
        {{ category.name }}
    {% else %}
        Skincare Products
    {% endif %}
{% endblock %}

{% block content %}

<div class="container my-5">
    <h2 class="text-center mb-4">
        Our Categories
       </h2>
  {# --- Category Cards Section --- #}
  <div class="row mb-4">
    {% for cat in categories|slice:":3" %}
      <div class="col-4 mb-3">
        <div class="card h-100">
          {% if cat.image %}
            <img src="{{ cat.image.url }}" class="card-img-top" alt="{{ cat.name }}">
          {% else %}
            <img src="{% static 'img/default-category.jpg' %}" class="card-img-top" alt="{{ cat.name }}">
          {% endif %}
          <div class="card-body text-center">
            <h5 class="card-title">{{ cat.name }}</h5>
            <a href="{% url 'shop:product_list_by_category' cat.slug %}" class="btn btn-primary btn-sm btn-block" style="margin-left: -16px;">
              View Products
            </a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="text-center mb-5">
    <a href="{% url 'shop:category_list' %}" class="btn btn-outline-secondary">See All Categories</a>
  </div>

  {# --- Product Grid Section (Slider Removed) --- #}
  <h2 class="text-center mb-4">
    {% if category %}{{ category.name }}{% else %}Our Products{% endif %}
  </h2>
  <div class="row">
    {% for product in products %}
      <div class="col-4 mb-4">
         <div class="product-card">
           <a href="{{ product.get_absolute_url }}">
             {% if product.image %}
               <img src="{{ product.image.url }}" alt="{{ product.name }}">
             {% else %}
               <img src="{% static 'img/no_image.png' %}" alt="No image available">
             {% endif %}
             <h3 class="product-name mt-2">{{ product.name }}</h3>
           </a>
           <p class="product-price text-muted">${{ product.price }}</p>
           <div class="share-buttons mt-2">
             {# Build the absolute URL using request.scheme, request.get_host and product.get_absolute_url #}
             {% with full_url=request.scheme|add:"://"|add:request.get_host|add:product.get_absolute_url %}
               <div class="dropdown share-dropdown">
                 <button style="margin-left: -14px;" class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="shareDropdown{{ product.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                   Share
                 </button>
                 <div class="dropdown-menu" aria-labelledby="shareDropdown{{ product.id }}">
                   <button class="dropdown-item" onclick="copyLink('{{ full_url }}')">Copy Link</button>
                   <a class="dropdown-item" href="https://www.facebook.com/sharer/sharer.php?u={{ full_url }}" target="_blank">Facebook</a>
                   <a class="dropdown-item" href="https://api.whatsapp.com/send?text={{ full_url }}" target="_blank">WhatsApp</a>
                 </div>
               </div>
             {% endwith %}
           </div>
         </div>
      </div>
    {% endfor %}
  </div>
</div>

<style>
  /* Product Card Styling */
  .product-card {
      background: #fff;
      border-radius: 8px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 15px;
  }
  .product-card:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }
  .product-card img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 4px;
  }
  .product-name {
      font-size: 1.1rem;
      color: #333;
      margin: 10px 0 8px;
  }
  .product-price {
      font-size: 1.2rem;
      color: #666;
  }
  /* Responsive adjustments for mobile: force 3 items per row */
  @media (max-width: 576px) {
      .col-4 {
          flex: 0 0 33.33%;
          max-width: 33.33%;
      }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      function isElementInViewport(el) {
          const rect = el.getBoundingClientRect();
          return (
              rect.top <= (window.innerHeight || document.documentElement.clientHeight) &&
              rect.bottom >= 0
          );
      }

      function animateOnScroll() {
          const elements = document.querySelectorAll('.scroll-animate');
          elements.forEach(el => {
              if (isElementInViewport(el)) {
                  el.classList.add('active');
              }
          });
      }

      window.addEventListener('scroll', animateOnScroll);
      animateOnScroll();
  });

  function copyLink(url) {
      navigator.clipboard.writeText(url).then(function() {
          alert('Link copied to clipboard!');
      }, function(err) {
          alert('Could not copy link. Error: ' + err);
      });
  }
</script>
{% endblock %}
